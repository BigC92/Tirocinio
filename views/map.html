<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title></title>
</head>
<body style="overflow: hidden ">
<script src="javascripts/three.min.js"></script>
<script src="javascripts/csg.js"></script>
<script src="javascripts/ThreeCSG.js"></script>
<script src="javascripts/THREEx.keyboardstate.js"></script>
<script src="javascripts/OrbitControls.js"></script>
<script src="javascripts/THREEx.FullScreen.js"></script>
<script src="javascripts/THREEx.WindowResize.js"></script>
<script>
    var renderer, scene, camera;
    var controls, texture, material;
    var clock = new THREE.Clock();

    var keyboard = new THREEx.KeyboardState();

    var plane;
    var auxPlane;

    init();
    animate();
    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 20000);
        camera.position.set(0,200,460);

        renderer = new THREE.WebGLRenderer({alpha: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        THREEx.WindowResize(renderer, camera);
        THREEx.FullScreen.bindKey({charCode: 'm'.charCodeAt(0)});
        controls = new THREE.OrbitControls( camera, renderer.domElement );
        controls.noZoom = true;
        controls.noRotate = true;
        controls.noPan = true;

        var geometry = new THREE.BoxGeometry(640, 640, 0.1);
        texture = THREE.ImageUtils.loadTexture("/image/<%=c_lat%>/<%=c_lon%>/<%=zoom%>", {},
                function () {});
        material = new THREE.MeshBasicMaterial({ map: texture, color: 0xffffff});
        plane = new THREE.Mesh(geometry, material);
        plane.position.y=-0.5;
        plane.rotation.x = -Math.PI/2;

        var aux = new THREE.BoxGeometry("<%=width%>", "<%=height%>", 0.1);
        var auxMesh = new THREE.Mesh(aux);
        var auxBSP = new ThreeBSP(auxMesh);

        var logical = new THREE.BoxGeometry(10000, 10000, 0.1);
        var logicalMesh = new THREE.Mesh(logical);
        var logicalBSP = new ThreeBSP(logicalMesh);

        var newPlaneBSP = logicalBSP.subtract(auxBSP);
        var newMaterial = new THREE.MeshBasicMaterial({color: 0xffffff});
        auxPlane = newPlaneBSP.toMesh(newMaterial);
        auxPlane.rotation.x = -Math.PI/2;

        scene.add(auxPlane);
        scene.add(plane);
    }

    function animate()
    {
        requestAnimationFrame( animate );
        render();
        update();
    }

    function update()
    {
        var moveDistance = 1;
        // move forwards/backwards/left/right
        if ( keyboard.pressed("up") ){
            console.log("up");
            if(plane.position.z < ((640 - parseFloat("<%=height%>"))/2)){
                plane.position.z += moveDistance;
            }
            console.log(plane.position.z);
        }
        if ( keyboard.pressed("down") ) {
            console.log("down");
            console.log((-640 + parseFloat("<%=height%>"))/2);
            if(plane.position.z > ((-640 + parseFloat("<%=height%>"))/2)){
                plane.position.z -= moveDistance;
            }
            console.log(plane.position.z);
        }
        if ( keyboard.pressed("left") ){
            console.log("left");
            console.log((640 - parseFloat("<%=width%>"))/2);
            if(plane.position.x < (640 - parseFloat("<%=width%>"))/2){
                plane.position.x += moveDistance;
            }
            console.log(plane.position.x);
        }
        if ( keyboard.pressed("right") ) {
            console.log("right");
            console.log((640 - parseFloat("<%=width%>"))/2);
            if(plane.position.x > (-640 + parseFloat("<%=width%>"))/2){
                plane.position.x -= moveDistance;
            }
            console.log(plane.position.x);
        }

        controls.update();
    }

    function render()
    {
        renderer.render( scene, camera );
    }

</script>
</body>
</html>